{"version":3,"file":"avosignals.js","sourceRoot":"","sources":["../avosignals.ts"],"names":[],"mappings":"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","sourcesContent":["import type { LitElement } from \"lit\";\n\nlet __DEV__ = true; //TODO - add logic to detect debug query param\n\ntype Job = () => void;\n\ntype Unsubscribe = () => void;\n\ninterface Debuggable {\n    _debugParent?: Watcher;\n}\n\ninterface Watcher extends Debuggable {\n    track(signal: Observable<unknown>): void;\n}\n\nfunction safe_not_equal(a: unknown, b: unknown) {\n    return a != a \n        ? b == b \n        : a !== b || ((a && typeof a === 'object') || typeof a === 'function');\n}\n\n\nfunction isWeakRef(value: any): value is WeakRef<any> {\n    return value && typeof value.deref === 'function';\n}\n\nabstract class Observable<T> {\n    static #nextId = 0;\n\n    #value: T;\n    #previousValue: T | undefined;\n    #subs = new Set<Job | WeakRef<Job>>();\n\n    #id = Observable.#nextId++;\n    name?: string;\n\n    constructor(initial: T, name?: string) {\n        this.#value = initial;\n        this.#previousValue = initial;\n        this.name = name;\n    }\n\n    protected _get(): T {\n        if (Signal.activeConsumer) {\n            Signal.activeConsumer.track(this);\n        }\n        return this.#value;\n    }\n\n    protected _set(next: T) {\n        if (!safe_not_equal(next, this.#value)) return false;\n        this.#previousValue = this.#value;\n        this.#value = next;\n        this._notify();\n        return true;\n    }\n\n    subscribe(fn: Job, weak = false): Unsubscribe {\n        let entry: Job | WeakRef<Job> = fn;\n        if (weak) {\n            entry = new WeakRef(fn);\n        }\n        this.#subs.add(entry);\n        return () => this.#subs.delete(entry);\n    }\n\n    _notify() {\n        const subs = [...this.#subs];\n\n        for (const entry of subs) {\n            let job: Job | undefined;\n\n            if (isWeakRef(entry)) {\n                job = entry.deref();\n                // If the object is garbage collected, remove the dead link\n                if (!job) {\n                    this.#subs.delete(entry);\n                    continue;\n                }\n            } else {\n                job = entry;\n            }\n\n            job();\n        }\n    }\n\n    get id() {\n        return this.#id;\n    }\n\n    get previousValue() {\n        return this.#previousValue;\n    }\n\n    toString() {\n        return this.name\n            ? `${this.constructor.name}(${this.name})`\n            : `${this.constructor.name}#${this.id}`;\n    }\n\n}\n\nexport class Signal<T> extends Observable<T> {\n    static #stack: Watcher[] = [];\n\n    constructor(initial: T, name?: string) {\n        super(initial, name);\n    }\n\n    static get activeConsumer() {\n        return this.#stack[this.#stack.length - 1];\n    }\n\n    static push(consumer: Watcher) {\n        if (__DEV__) {\n            consumer._debugParent = this.activeConsumer;\n        }\n        this.#stack.push(consumer);\n    }\n\n    static pop() {\n        if (__DEV__ && !this.#stack.length) {\n            throw new Error('Signal.pop() without matching push()');\n        }\n        this.#stack.pop();\n    }\n\n    get(): T {\n        return this._get();\n    }\n\n    set(value: T) {\n        if (__DEV__ && Signal.activeConsumer) {\n            throw new Error(\n                `Signal write during reactive evaluation:\\n` +\n                `  writing ${this}\\n` +\n                `  while computing ${Signal.activeConsumer}`\n            );\n        }\n        this._set(value);\n    }\n\n    update(fn: (current: T) => T) {\n        this.set(fn(this.get()));\n    }\n}\n\nexport class Computed<T> extends Observable<T> implements Watcher {\n    #fn: () => T;\n    #dirty = true;\n    #computing = false;\n    #deps = new Map<Observable<unknown>, Unsubscribe>();\n    _debugParent: Watcher | undefined;\n    #weak;\n\n    // 1. Create a stable, bound reference to the notification logic\n    #notifyCallback = () => {\n        if (this.#dirty) return;\n        this.#dirty = true;\n        this._notify();\n    };\n\n    constructor(fn: () => T, name?: string, options?: { weak?: boolean }) {\n        super(undefined as T, name);\n        this.#fn = fn;\n        // Default to TRUE (Weak) for standard computeds to prevent leaks\n        this.#weak = options?.weak ?? true;\n    }\n\n    track(signal: Observable<unknown>) {\n        if (this.#deps.has(signal)) return;\n\n        // 2. Subscribe using the STABLE callback and WEAK flag\n        const unsub = signal.subscribe(this.#notifyCallback, this.#weak);\n\n        this.#deps.set(signal, unsub);\n    }\n\n    dispose() {\n        this.#cleanup();\n    }\n\n    #cleanup() {\n        for (const unsub of this.#deps.values()) unsub();\n        this.#deps.clear();\n    }\n\n    get() {\n        if (Signal.activeConsumer) {\n            Signal.activeConsumer.track(this);\n        }\n\n        if (!this.#dirty) return this._get();\n\n        if (this.#computing) {\n            throw new Error(\n                `Cycle detected in ${this}\\n` +\n                `â†³ while computing ${this._debugParent ?? 'root'}`\n            );\n        }\n\n        this.#computing = true;\n        this.#cleanup();\n\n        Signal.push(this);\n        try {\n            const value = this.#fn();\n            this._set(value);\n        } finally {\n            Signal.pop();\n            this.#dirty = false;\n            this.#computing = false;\n        }\n\n        return this._get();\n    }\n\n    override subscribe(fn: Job, weak = false): Unsubscribe {\n        const unsub = super.subscribe(fn, weak);\n        //ensure we don't affect tracking\n        if (!Signal.activeConsumer) this.get();\n        \n        return unsub;\n    }\n}\n\nexport function effect(fn: () => (void | (() => void)), name?: string) {\n    let cleanup: (() => void) | void;\n\n    const computer = new Computed(() => {\n        if (typeof cleanup === 'function') cleanup();\n        cleanup = fn();\n    }, name, { weak: false });\n\n    const unsub = computer.subscribe(() => {\n        computer.get();\n    });\n\n    computer.get();\n    \n    return () => {\n        unsub();\n        computer.dispose();\n        if (typeof cleanup === 'function') cleanup();\n    };\n}\n\n// Lit\n\nexport class SignalWatcher implements Watcher {\n    #host: LitElement;\n    #deps = new Map<Observable<unknown>, Unsubscribe>();\n    _debugParent: Watcher | undefined;\n    #active = false;\n\n    constructor(host: LitElement) {\n        this.#host = host;\n        host.addController(this);\n    }\n\n    track(signal: Observable<unknown>) {\n        if (this.#deps.has(signal)) return;\n        \n        this.#deps.set(\n            signal,\n            signal.subscribe(() => this.#host.requestUpdate())\n        );\n        \n    }\n\n    hostUpdate() {\n        for (const unsub of this.#deps.values()) unsub();\n        this.#deps.clear();\n        Signal.push(this);\n        this.#active = true;\n    }\n\n    hostUpdated() {\n        if (this.#active) {\n            Signal.pop();\n            this.#active = false;\n        }\n    }\n\n    hostDisconnected() {\n        for (const unsub of this.#deps.values()) unsub();\n        this.#deps.clear();\n        // optional safety if the component disconnects mid-render\n        if (this.#active) {\n            Signal.pop();\n            this.#active = false;\n        }\n    }\n}"]}